# ppv1

The Takuvik and UQAR model is a light photosynthesis model that uses satellite data of chlorophyll-a to estimate the net primary production (NPP) in the Arctic Ocean.

The methodology of the NPP model was first published by Belanger et al. 2013 (doi:10.5194/bg-10-4087-2013). The NPP codes from Belanger et al. 2013 was modified for vertically resolved chl-a according to Ardyna et al 2013 (doi:10.5194/bg-10-4383-2013). The model was originally run using MODIS reflectances as input data. Currently the model has been adapted by the Takuvik group to use reflectances from the ESA CCI v6.0 product.

Go to trunk > Source to begin.

# Takuvik net primary production model (starter guide)

This document provides general information to quickly start with PPv1.

## Table of Contents

1. [Docker installation](#docker-installation)
2. [Download PPv1 docker](#download-ppv1-docker)
2. [Build PPv1 docker](#build-ppv1-docker)
3. [Configure PPv1 input files](#configure-ppv1-input-files)
4. [Run PPv1 docker](#run-ppv1-docker)

## Docker installation (#docker-installation)

PPv1 has been build in a [Docker](https://www.docker.com/) image. The first step is to install Docker on your machine. Please consult [Docker documentation](https://docs.docker.com/install/) to install Docker on your computer.


## Build a docker image of ppv1
In your machine, in the folder where you have downloaded the ppv1 model, you should create a .git folder

In the terminal go to the directory where you have downloaded ppv1

```bash=
cd <YOUR_LocalFolder>ppv1/
```

Then,

```bash=
git init
git add .
git commit -m "add my files ppv1"
```
Once the ppv1.git has been created you must to build the ppv1 docker
Note that you need to be in the Source folder (where the Dockerfile is located) to run the build command.

```bash=
docker build -t takuvik/ppv1 .
docker push takuvik/ppv1
Docker run -it \
```

## Download PPv1 docker

Once Docker is installed, you will need to pull PPv1 image on your machine. At this time, the docker is private and you will need to log on [Docker Hub](https://hub.docker.com/) first.  You will need to ask your system administrator for access granted.

```bash=
docker login
docker pull takuvik/ppv1
```

## Configure PPv1 input files

A JSON configuration file is needed to run PPv1. This file provides information about the user inputs to be used within PPv1.

###  Required variables

`calculation_start_date`: first date to calculate  
`calculation_end_date`: last date to calculate (only one day if `calculation_start_date` == `calculation_start_date`)  
`calculation_time_step_in_offset_alias`: string to specify time step in python [pandas offset](https://pandas.pydata.org/pandas-docs/stable/timeseries.html#timeseries-offset-aliases)  

`input_file`: a dictionary of input files referred in the variable section. 
* `input_file_name`: name of the input file name as referred in the variable section
    * `file_path_template_type`: value to resolve in the path and filename format for each date   (takes one of the following value)
        * `constant_file`: `/.../folder/my_file.csv`
        * `fixed_directory_variable_file_ymd`: `/.../folder/my_file_{yyyy}_{mm}_{dd}.csv`
        * `year_and_day_of_year` : `/.../{yyyy}/{doy}/my_file_{yyyy}_{doy}.csv`
    * `path_format`: base path for each file: ".../folder/{}/{}"
    * `file_name_format` : "data_rimouski_ppv1_{}{}{}.csv"
    * `type`: type of file to load   (takes one of the following value)
        * `netcdf_from_ppv0`: legacy support (ppv0 output)
        * `netcdf_from_bloomstate2`: Output generated by bloomstate script
        * `netcdf_indexed_one_level`: Regular NetCDF, with variables at the root
        * `base`: Loading behavior is explicitly coded by file (avoid usage)
        * `flat_json`: JSON with all values at it's root
        * `csv`: Regular CSV file
    * `details` (optional) : dictionary of special variable to use. Mostly used for passing indexing variable name
        * `{index_variable" : "bin_index"}`

`variable`: dictionnary of all variable to be used (all are mendatory)
* `variable_name` : 
    * `input_file_name`: reference to input_file farther down in the exmaple
    * `column_name`: reference to the column name within the file  
    * `type`: type of value to extract (takes one of the following value)
        * `single_value`: a scalar value (used for boolean etc.)
        * `vector`: a one dimension indexed vector (used with pixel index)
        * `2_dimentions` : a two dimensions indexed matrix (use with pixel index and depth, ex.: Eric R. bloomstate 2)
    * `details` (optional): dictionnary for special variable type.
    


`output_configuration`: a dictionary of values for output
* `path_format`: output equivalent of the input file path format
* `file_name_format`: output equivalent of the input file path format
        
    
###  Example Configuration file (JSON document)
Modify start (<"yyyy-mm-ddT00:00:00.000Z">) and end (<"yyyy-mm-ddT00:00:00.000Z">) dates, and input ("<InputDataPathFolder>") and output (<"OutputDataFolder">) data folders.

{
  "calculation_start_date": <"2019-08-17T00:00:00.000Z">,
  "calculation_end_date": <"2019-08-17T00:00:00.000Z">,
  "calculation_time_step_in_offset_alias": "1D",

  "input_file": {
        "takuvik_atmosphere": {
            "file_path_template_type": "year_and_day_of_year",
            "file_type": "netcdf_indexed_one_level",
            "path_format": "<InputDataPathFolder/{}/{}/>",
            "file_name_format": "A{}{}_061_.L3b_DAY_ATMOSPHERE_above_45n.nc",
            "details": {
                "index_variable": "bin_index"
            }
        },
        "takuvik_rrs": {
            "file_path_template_type": "year_and_day_of_year",
            "file_type": "netcdf_indexed_one_level",
            "path_format": "<InputDataPathFolder/{}/{}/>",
            "file_name_format": "<netCDF_Reflectanctes_File>",
            "details": {
                "index_variable": "bin_index"
            }
        },
        "takuvik_chla": {
            "file_path_template_type": "year_and_day_of_year",
            "file_type": "netcdf_from_bloomstate2",
            "path_format": "<InputDataPathFolder/{}/{}/>",
            "file_name_format": "<netCDF_Chlorophyll_File">,
            "details": {
                "index_variable": "bin_index"
            }
        },
        "takuvik_bathy": {
            "file_path_template_type": "constant_file",
            "file_type": "csv",
            "path_format": "<InputDataPathFolder>",
            "file_name_format": "<csv_ProvinceZbot_File">,
            "details": {
                "index_variable": "bin_index"
            }
        },
        "other_values": {
            "file_path_template_type": "constant_file",
            "file_type": "flat_json",
            "path_format": "<InputDataPathFolder>",
            "file_name_format": "other_values_pp_integration.json"
        },
        "downward_irradiance_table": {
            "file_path_template_type": "constant_file",
            "file_type": "base",
            "path_format": "<InputDataPathFolder>",
            "file_name_format": "Ed0moins_LUT_5nm_v2.dat"
        }
    },
    "variable": {
        "rrs_412": {
            "input_file_name": "takuvik_rrs",
            "column_name": "Rrs412",
            "type": "vector"
        },
        "rrs_443": {
            "input_file_name": "takuvik_rrs",
            "column_name": "Rrs443",
            "type": "vector"
        },
        "rrs_488": {
            "input_file_name": "takuvik_rrs",
            "column_name": "Rrs488",
            "type": "vector"
        },
	"rrs_531": {
            "input_file_name": "takuvik_rrs",
            "column_name": "Rrs531",
            "type": "vector"
        },
        "rrs_555": {
            "input_file_name": "takuvik_rrs",
            "column_name": "Rrs555",
            "type": "vector"
        },
	"rrs_667": {
            "input_file_name": "takuvik_rrs",
            "column_name": "Rrs667",
            "type": "vector"
        },
        "cloud_fraction": {
            "input_file_name": "takuvik_atmosphere",
            "column_name": "CF_mean",
            "type": "vector"
        },
        "taucl": {
            "input_file_name": "takuvik_atmosphere",
            "column_name": "TauCld_mean",
            "type": "vector" 
        },
        "ozone": {
            "input_file_name": "takuvik_atmosphere",
            "column_name": "O3_mean",
            "type": "vector"
        },
        "latitude": {
            "input_file_name": "takuvik_rrs",
            "column_name": "lat",
            "type": "vector"
       },
        "longitude": {
            "input_file_name": "takuvik_rrs",
            "column_name": "lon",
            "type": "vector"
        },
        "bathymetry_maximum_depth": {
            "input_file_name": "takuvik_bathy",
            "column_name": "Zbot",
            "type": "vector"
        },
        "chlorophyl": {
            "input_file_name": "takuvik_chla",
            "column_name": "chlz",
            "type": "two_dimentions",
            "details": {
                "type": "vertical_profile"
            }
        },
        "primary_production_integration": {
            "input_file_name": "other_values",
            "column_name": "primary_production_integration",
            "type": "single_value"
        },
        "rrs_type": {
            "input_file_name": "other_values",
            "column_name": "rrs_type",
            "type": "single_value"
        }
    },
    "output_configuration": {
        "path_format": <"OutputDataFolder">,
        "file_name_format": "cci_v6_{}{}_ppz_takuvik_above_45n_v2.csv"
    }
}


## Run PPv1 docker

```bash=
docker run -it [-v section] takuvik/ppv1 [configuration file path]
```
### -v section

docker needs acces to configuration file, input and output path that are stored outside the docker. the -v argument maps [host folder]:[container folder]. These path will highly depend on your configuration file and your computer setup.

#### Access to configuration file

add `-v [folder where your file is]:/takuvik/configuration_file`

#### Acces to input file

add `-v [where on your computer the root of the data source is]:[where the config file will search]`

#### Acces to output file

add `-v [where on your computer the root of the data output is]:[where the configuration file will save the folder search]`

### Docker run command example
```bash=
docker run -it \
-v /home/jtbai/Programs/mixed/ppv1/trunk/Source/configuration_file/:/takuvik/configuration_file \
-v /mnt/nfs/:/mnt/nfs/ \
takuvik/ppv1 configuration_file/dev_run_one_image_with_pp_integration.json 
```

Latest working version:

```bash=
docker run -it \
-v /home/pmassicotte/Desktop/:/takuvik/configuration_file \
-v /mnt/nfs/:/mnt/nfs/ \
ppv1 configuration_file/config_ppz.json
```

#### Command explanation ####
```bash=
Docker run with a terminal and an interactive command 
mapping of configuration_file path 
mapping the input AND output root
[docker image] [target configuration file]
```

## Build PPv1

```bash=
docker build -t ppv1 .
```

## Push PPv1

```bash=
docker push takuvik/ppv1
```


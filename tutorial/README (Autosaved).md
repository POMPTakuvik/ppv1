# PPv1 tutorial

All the data (atmospheric, Rrs, Chl, bathymetry, LUT) and the configuration files needed to run this demo are located in the `tutorial` folder of the [NPP repository]. This demo will show how to run PPv1 to calculate integrated daily primary production for 2019-08-17 (year day 229 of 2019) using CCI data and vertical chlorophyll profile generated by bloomstate2.

## Install Docker

### Docker installation

PPv1 has been build in a [Docker](https://www.docker.com/) image. The first step is to install Docker on your machine. Please consult [Docker documentation](https://docs.docker.com/install/) to install Docker on your computer. Note that this document is not about teaching you how to use Docker. You will have to learn it by yourself.

### Download PPv1 docker

Once Docker is installed, you will need to pull the NPP image on your machine. At this time, the docker is private and you will need to log on [Docker Hub](https://hub.docker.com/) first. Create an account if needed. [You can use this link to view the PPv1 image](https://hub.docker.com/repository/docker/takuvik/ppv1).

```bash
docker login
docker pull takuvik/ppv1
```

- `docker login` will prompt you for your credential.
- `docker pull takuvik/ppv1` will download the [PPv1 docker image](https://hub.docker.com/repository/docker/takuvik/ppv1) on your computer.

## Running the example

Once the `ppv1` docker is installed, you will be able to execute a test run as follow after making some quick changes to the configuration file (see later). It takes about 20 minutes to run a single day (depending on your PC configuration and the number of documented pixels).

```bash
docker run -it \
-v /home/filoche/Desktop/ppv1/tutorial/inputs/config:/takuvik/configuration_file \
-v /home/filoche/Desktop/ppv1/tutorial/inputs/:/data/ \
takuvik/ppv1 configuration_file/config_surface.json
```

![](img/run_docker.png)

Let's understand what this command does.

1. Using `-v`, set the path where the config file is located on **your** computer. In this example, the file `config_integration_using_chlz_bloomstate2.json` is located in `/home/filoche/Desktop/ppv1/tutorial/inputs/config` folder on **my** computer. This means that you have to replace `/home/filoche/Desktop/ppv1/tutorial/inputs/config` with the path of the `config/` folder on **your computer**.

2. Using `-v`, set the path where the data is located on **your** computer. In this example, all the data are located in the `/home/filoche/Desktop/ppv1/tutorial/inputs` folder on **my** computer. This means that you have to replace `/home/filoche/Desktop/ppv1/tutorial/inputs` with the path of the `inputs/` folder on **your computer**.

3. Which configuration file to use. This is in this file that you provide the information specifying:
   - Which data to use (Rrs, chl, bathymetry, etc.).
   - The start and the end time of the calculation.
   - The integration of primary production:
     - Do not integrate and only export the surface PP.
     - Vertical *homogeneous integration* using surface chlorophyll.
     - Vertical *heterogeneous integration* using profile chlorophyll from bloomstate2.

This image shows an example of a configuration file that uses bloomstate2 chlorophyll. In the `tutorial` folder, there are configuration file examples for the three possible ways to use PPv1:

- `config_integration_using_chl0_modis.json`: Vertically homogeneous integration using surface chlorophyll.
  
- `config_surface.json`: No vertical integration using surface chlorophyll.
  
- `config_integration_using_chlz_bloomstate2.json`: Vertically heterogeneous integration using vertical chlorophyll derived from bloomstate2.

In the following script:

1. Start date of the calculation.
2. End date of the calculation.
3. Time step of the calculation (`1D` or `8D`).
4. Location of the atmosphere file data (netcdf).
5. Location of the rrs file data (netcdf).
6. Location of the chlorophyll file data (netcdf from bloomstate).

The rest of the configuration file should be easy to understand.

![](img/config_example_bloomstate2.png)

Note that PPv1 needs the data arranged in folders that follow a `year` and `day of year` structure. For example, `/data/MODISA/L3BIN/{}/{}/` means that MODIS data will be in the `/data/MODISA/L3BIN/{year}/{yday}/`. The first `{}` is for the year in the YYYY format and the second `{}` is the day of the year using **three** digits ddd. This can be, for example, a folder on your computer named `/data/MODISA/L3BIN/2016/183/`.

In the `config_integration_using_chlz_bloomstate2.json` there are these information:

- `"path_format": "/data/MODISA/L3BIN/{}/{}/"`
- `"file_name_format": "A{}{}_061_.L3b_DAY_ATMOSPHERE_above_45n.nc"`

This means that PPv1 will be looking for the atmosphere file named `/data/MODISA/L3BIN/2016/283/A2016283_061_.L3b_DAY_ATMOSPHERE_above_45n.nc`.

![](img/input_file_structure.png)

To make things clear. Using the information provided in the next figure:

- You create a folder on the docker that is called `data`. This `data` folder will have all the data that is located in `/home/filoche/Desktop/ppv1/tutorial/inputs/` on **your computer** (see #3 red circle).

- `A2016283_061_.L3b_DAY_ATMOSPHERE_above_45n.nc` should then be present in `/home/filoche/Desktop/ppv1/tutorial/inputs/MODISA/L3BIN/2016/283/A2016283_061_.L3b_DAY_ATMOSPHERE_above_45n.nc`.

![](img/example_data_path.png)

Finally, you have to configure where you export the data. In the config file `config_integration_using_chlz_bloomstate2.json` (at the end):

![](img/export_config.png)

1. Location where the results will be exported.
2. Name of the files to be exported.

In this example, the exported file will be named `/data/results/pp/1_2_10_1/2016/283/AM2016283_integrated_chlz_bloomstate2.csv`.

![](img/export_file_format.png)

## Modify PPv1 code

The code of PPv1 can be modified. You will have to first download the code on your computer using either the `git clone` command or [dowloading the repository from Gitlab](https://gitlab.com/Takuvik/primary-production/primary-production-vertically-resolved/ppv1/-/tree/master/).

![](img/gitlab_download.png)

### Git clone

If you have git installed, you can clone the repository as follow:

```bash
git clone git@gitlab.com:Takuvik/primary-production/primary-production-vertically-resolved/ppv1.git
```

### Modify the code

Once you have downloaded the PPv1 repository, you can browse and modify the source code contained in the `Source` folder.

![](img/source_folder.png)

### Docker build PPv1

After you have made modifications to the source code, you will have to rebuild the PPv1 docker:

```bash
docker build -t ppv1 .
```

**Note that you need to be in the `Source` folder (where the `Dockerfile` is located) to run the build command.**

After a successful docker builds, you can run it as before.

```bash
docker run -it \
-v /home/filoche/Desktop/ppv1/tutorial/inputs/config:/takuvik/configuration_file \
-v /home/filoche/Desktop/ppv1/tutorial/inputs/:/data/ \
takuvik/ppv1 configuration_file/config_surface.json
```

## Using new data with PPv1

If you want to use your data (Rrs, Chl, Ozone, etc.) with PPv1, you have to use the NetCDF files that have the same structure as the ones currently used. If the data is not formatted the same way as it is currently supported by PPv1, you have two options:

1. Modify the code of PPv1 to make it able to read your new data.
2. Create code to make your data in a format compatible with PPv1.
